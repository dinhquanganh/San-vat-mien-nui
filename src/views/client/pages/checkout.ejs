<!DOCTYPE html>
<html lang="en">
  <%- include("../layouts/head.ejs") -%>
  <body class="home-4">
    <div id="main">
      <!-- Header Start -->
      <header class="main-header home-2">
        <%- include("../layouts/navbar.ejs") -%>
      </header>
      <!-- Header End -->

      <!-- Breadcrumb Area start -->
      <%- include("../layouts/breadcumb.ejs") -%>
      <!-- Breadcrumb Area End -->
      <!-- checkout area start -->
      <div class="checkout-area mt-60px mb-40px">
        <div class="container">
          <div class="row">
            <div class="col-lg-7">
              <div class="billing-info-wrap">
                <h3>Chi tiết thanh toán</h3>
                <div class="row">
                  <div class="col-lg-12">
                    <div class="billing-info mb-20px">
                      <label>Họ tên</label>
                      <input type="text" name="name" id="orderName" />
                    </div>
                  </div>
                  <div class="col-lg-6 col-md-6">
                    <div class="billing-info mb-20px">
                      <label>Số điện thoại</label>
                      <input type="text" name="phoneNumber" id="orderPhone" />
                    </div>
                  </div>
                  <div class="col-lg-6 col-md-6">
                    <div class="billing-info mb-20px">
                      <label>Email</label>
                      <input type="text" name="email" id="orderEmail" />
                    </div>
                  </div>
                  <div class="col-lg-12">
                    <div class="billing-info mb-20px">
                      <label>Địa chỉ nhận hàng</label>
                      <input
                        class="billing-address"
                        placeholder="Nhập địa chỉ nhận hàng của bạn"
                        type="text"
                        id="orderAddress"
                      />
                    </div>
                  </div>
                </div>
                <div class="additional-info-wrap">
                  <h4>Thông tin bổ sung</h4>
                  <div class="additional-info">
                    <label>Ghi chú đơn hàng</label>
                    <textarea
                      placeholder="Ghi chú về đơn đặt hàng của bạn, ví dụ: những lưu ý đặc biệt khi giao hàng."
                      name="order-note"
                      id="orderNote"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="your-order-area">
                <h3>Đơn hàng của bạn</h3>
                <div class="your-order-wrap gray-bg-4">
                  <div class="your-order-product-info">
                    <div class="your-order-top">
                      <ul>
                        <li>Sản phẩm</li>
                        <li>Tổng</li>
                      </ul>
                    </div>
                    <div class="your-order-middle">
                      <ul id="order-list"></ul>
                    </div>
                    <div class="your-order-bottom">
                      <ul>
                        <li class="your-order-shipping">Phí giao hàng</li>
                        <li><span class="price-cv">30000 </span>VND</li>
                      </ul>
                    </div>
                    <div class="your-order-total">
                      <ul>
                        <li class="order-total">Tổng</li>
                        <li id="order-total">0 VND</li>
                      </ul>
                    </div>
                  </div>
                  <div class="payment-method">
                    <div class="payment-accordion element-mrg">
                      <div class="panel-group" id="accordion">
                        <div class="panel payment-accordion">
                          <div class="panel-heading" id="method-three">
                            <h4 class="panel-title">
                              <a
                                class="collapsed"
                                data-toggle="collapse"
                                data-parent="#accordion"
                                href="#method3"
                              >
                                Thanh toán khi nhận hàng
                              </a>
                            </h4>
                          </div>
                          <div id="method3" class="panel-collapse collapse">
                            <div class="panel-body">
                              <p>
                                Bạn sẽ nhận được hàng và kiểm tra đầy đủ trước
                                khi thanh toán
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="Place-order mt-25 btn-hover" onclick="orderNow()">
                  <a>Đặt hàng</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- checkout area end -->

      <!-- Brand area end -->
      <%- include("../layouts/footer.ejs") -%>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">x</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5 col-sm-12 col-xs-12">
                <div class="tab-content quickview-big-img">
                  <div id="pro-1" class="tab-pane fade show active">
                    <img
                      src="/assets/images/product-image/organic/product-11.jpg"
                      alt=""
                    />
                  </div>
                  <div id="pro-2" class="tab-pane fade">
                    <img
                      src="/assets/images/product-image/organic/product-9.jpg"
                      alt=""
                    />
                  </div>
                  <div id="pro-3" class="tab-pane fade">
                    <img
                      src="/assets/images/product-image/organic/product-20.jpg"
                      alt=""
                    />
                  </div>
                  <div id="pro-4" class="tab-pane fade">
                    <img
                      src="/assets/images/product-image/organic/product-19.jpg"
                      alt=""
                    />
                  </div>
                </div>
                <!-- Thumbnail Large Image End -->
                <!-- Thumbnail Image End -->
                <div class="quickview-wrap mt-15">
                  <div
                    class="quickview-slide-active owl-carousel nav owl-nav-style owl-nav-style-2"
                    role="tablist"
                  >
                    <a class="active" data-toggle="tab" href="#pro-1"
                      ><img
                        src="/assets/images/product-image/organic/product-11.jpg"
                        alt=""
                    /></a>
                    <a data-toggle="tab" href="#pro-2"
                      ><img
                        src="/assets/images/product-image/organic/product-9.jpg"
                        alt=""
                    /></a>
                    <a data-toggle="tab" href="#pro-3"
                      ><img
                        src="/assets/images/product-image/organic/product-20.jpg"
                        alt=""
                    /></a>
                    <a data-toggle="tab" href="#pro-4"
                      ><img
                        src="/assets/images/product-image/organic/product-19.jpg"
                        alt=""
                    /></a>
                  </div>
                </div>
              </div>
              <div class="col-md-7 col-sm-12 col-xs-12">
                <div class="product-details-content quickview-content">
                  <h2>Originals Kaval Windbr</h2>
                  <p class="reference">Reference:<span> demo_17</span></p>
                  <div class="pro-details-rating-wrap">
                    <div class="rating-product">
                      <i class="ion-android-star"></i>
                      <i class="ion-android-star"></i>
                      <i class="ion-android-star"></i>
                      <i class="ion-android-star"></i>
                      <i class="ion-android-star"></i>
                    </div>
                    <span class="read-review"
                      ><a class="reviews" href="#">Read reviews (1)</a></span
                    >
                  </div>
                  <div class="pricing-meta">
                    <ul>
                      <li class="old-price not-cut">VND18.90</li>
                    </ul>
                  </div>
                  <p>
                    Lorem ipsum dolor sit amet, consectetur adipisic elit eiusm
                    tempor incidid ut labore et dolore magna aliqua. Ut enim ad
                    minim venialo quis nostrud exercitation ullamco
                  </p>
                  <div class="pro-details-size-color">
                    <div class="pro-details-color-wrap">
                      <span>Color</span>
                      <div class="pro-details-color-content">
                        <ul>
                          <li class="blue"></li>
                          <li class="maroon active"></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="pro-details-quality">
                    <div class="cart-plus-minus">
                      <input
                        class="cart-plus-minus-box"
                        type="text"
                        name="qtybutton"
                        value="1"
                      />
                    </div>
                    <div class="pro-details-cart btn-hover">
                      <a href="#"> + Thêm vào giỏ</a>
                    </div>
                  </div>
                  <div class="pro-details-wish-com">
                    <div class="pro-details-wishlist">
                      <a href="#"
                        ><i class="ion-android-favorite-outline"></i>Add to
                        wishlist</a
                      >
                    </div>
                    <div class="pro-details-compare">
                      <a href="#"
                        ><i class="ion-ios-shuffle-strong"></i>Add to compare</a
                      >
                    </div>
                  </div>
                  <div class="pro-details-social-info">
                    <span>Share</span>
                    <div class="social-info">
                      <ul>
                        <li>
                          <a href="#"><i class="ion-social-facebook"></i></a>
                        </li>
                        <li>
                          <a href="#"><i class="ion-social-twitter"></i></a>
                        </li>
                        <li>
                          <a href="#"><i class="ion-social-google"></i></a>
                        </li>
                        <li>
                          <a href="#"><i class="ion-social-instagram"></i></a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal end -->

    <%- include("../layouts/script.ejs") -%>

    <script>
      (() => {
        let cartListItem = JSON.parse(localStorage.getItem('cart')) || [];

        if (!cartListItem?.length) {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Không có sản phẩm nào!'
          });

          window.location.href = '/';
        }
      })();
    </script>

    <script>
      async function getCartData(query) {
        let data = await fetch(`/product/search?${query}`);
        data = await data.json();
        return data;
      }

      let totalMoney = 0;
      const orderTotalElement = document.querySelector('#order-total');

      const orderListElement = document.querySelector('#order-list');
      const orderListItem = JSON.parse(localStorage.getItem('cart'));
      let queryProducts = '';
      let orderListData = [];

      let orderListHTML = '';

      if (orderListItem) {
        orderListItem.forEach((item) => {
          queryProducts += `id=${item.productId}&`;
        });

        (async () => {
          orderListData = await getCartData(queryProducts);

          orderListData.forEach((item) => {
            orderListItem.forEach((orderItem) => {
              if (item._id.toString() == orderItem.productId) {
                totalMoney += item.price * orderItem.quantity;

                orderListHTML += `
                        <li>
                          <span class="order-middle-left">
                            ${item.name} x ${orderItem.quantity}
                          </span>
                          <span class="order-price price-cv">
                            ${orderItem.quantity * item.price} VND
                          </span>
                        </li>
                      `;
              }
            });
          });

          orderTotalElement.innerHTML = `
                  <span>${convertNumber(totalMoney + 30000)} VND</span>
                `;

          orderListElement.innerHTML = orderListHTML;
        })();
      } else {
        console.log(false);
      }

      function orderNow() {
        const orderName = document.querySelector('#orderName').value;
        const orderPhone = document.querySelector('#orderPhone').value;
        const orderEmail = document.querySelector('#orderEmail').value;
        const orderAddress = document.querySelector('#orderAddress').value;
        const orderNote = document.querySelector('#orderNote').value;

        (async function () {
          Swal.fire({
            title: 'Bạn chắc chắn muốn đặt đơn hàng này?',
            confirmButtonText: 'Chắc chắn',
            showLoaderOnConfirm: true,
            showCancelButton: true,
            cancelButtonText: 'Huỷ',
            preConfirm: (login) => {
              return fetch('/checkout', {
                headers: {
                  Accept: 'application/json',
                  'Content-Type': 'application/json'
                },
                method: 'POST',
                body: JSON.stringify({
                  productList: orderListItem,
                  user: {
                    name: orderName,
                    phoneNumber: orderPhone,
                    email: orderEmail || '',
                    deliveryAddress: orderAddress,
                    note: orderNote || ''
                  }
                })
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error(response.statusText);
                  }
                  return response.json();
                })
                .catch((error) => {
                  Swal.showValidationMessage(`Request failed: ${error}`);
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            console.log(result);
            if (result.value?.message === 'success') {
              Swal.fire({
                icon: 'success',
                title: 'Đặt hàng thành công!',
                html: 'Đang quay lại trang chủ trong <b></b> giây.',
                timer: 2000,
                didOpen: () => {
                  Swal.showLoading();
                  const b = Swal.getHtmlContainer().querySelector('b');
                  timerInterval = setInterval(() => {
                    b.textContent = Swal.getTimerLeft();
                  }, 500);
                }
              });

              localStorage.setItem('cart', '[]');

              setTimeout(() => {
                window.location.href = '/';
              }, 2000);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Xảy ra lỗi! Vui lòng thử lại sau ít phút!',
                timer: 1500
              });
            }
          });
        })();
      }
    </script>
  </body>
</html>
